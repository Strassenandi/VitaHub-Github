<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HealthCare">
    <meta name="theme-color" content="#ffffff">

    <title>Meine Familie - Gesundheitsakte</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes growBar {
            from {
                height: 0;
            }

            to {
                height: var(--h);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-zoom-in {
            animation: zoomIn 0.3s ease-out forwards;
        }

        .animate-grow-bar {
            animation: growBar 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /*neonrahmen*/
        .input-neon {
            position: relative;
            width: 100%;
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid transparent;
            color: #1e293b;
            font-size: 0.95rem;
            font-weight: 500;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .input-neon::before {
            content: '';
            position: absolute;
            inset: -4px;
            z-index: -1;
            border-radius: 1.375rem;
            background: linear-gradient(45deg, #10b981, #059669, #047857, #10b981);
            background-size: 300% 300%;
            filter: blur(12px);
            opacity: 0.6;
            animation: neonPulse 3s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        @keyframes neonPulse {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(1);
            }

            50% {
                opacity: 0.85;
                transform: scale(1.02);
            }
        }

        .input-neon:focus {
            transform: translateY(-2px);
            box-shadow:
                0 20px 40px rgba(16, 185, 129, 0.3),
                0 0 0 4px rgba(16, 185, 129, 0.2),
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        .input-neon:focus::before {
            opacity: 1;
            filter: blur(16px);
            box-shadow:
                0 0 30px rgba(16, 185, 129, 0.6),
                0 0 60px rgba(16, 185, 129, 0.4),
                0 0 100px rgba(16, 185, 129, 0.25);
            animation: neonFocusPulse 0.6s ease-out, neonPulse 2s ease-in-out infinite 0.3s;
        }

        @keyframes neonFocusPulse {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        .input-neon::placeholder {
            color: #94a3b8;
            font-weight: 400;
            opacity: 0.8;
        }

        .input-neon-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 3rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .input-neon[component="textarea"] {
            resize: vertical;
            min-height: 80px;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .input-neon:hover {
            transform: translateY(-1px);
        }

        .input-neon:hover::before {
            opacity: 0.8;
            filter: blur(14px);
        }

        .input-base {
            @apply w-full px-4 py-3 rounded-xl bg-white border-2 border-emerald-400 text-slate-900 text-sm font-medium placeholder:text-slate-400 focus:outline-none focus:border-emerald-500 focus:shadow-[0_0_15px_rgba(16, 185, 129, 0.4)] shadow-[0_0_8px_rgba(52, 211, 153, 0.3)] transition-all appearance-none;
        }
    </style>
</head>

<body class="bg-slate-50/50 text-slate-800 selection:bg-indigo-100 h-screen overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconBase = ({ d, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
            </svg>
        );

        // --- ICONS ---
        // A collection of SVG icons used throughout the application.
        // Using a functional component approach for tree-shaking friendliness (in a real build).
        const Icons = {
            Users: (p) => <IconBase d={["M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2", "M9 8.5a4 4 0 1 0 0-8 4 4 0 0 0 0 8", "M22 21v-2a4 4 0 0 0-3-3.87", "M16 3.13a4 4 0 0 1 0 7.75"]} {...p} />,
            ChevronRight: (p) => <IconBase d="m9 18 6-6-6-6" {...p} />,
            Activity: (p) => <IconBase d="M22 12h-4l-3 9L9 3l-3 9H2" {...p} />,
            Pill: (p) => <IconBase d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z" {...p} />,
            Calendar: (p) => <IconBase d={["M8 2v4", "M16 2v4", "M3 10h18", "M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z"]} {...p} />,
            FileText: (p) => <IconBase d={["M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z", "M14 2v6h6", "M16 13H8", "M16 17H8", "M10 9H8"]} {...p} />,
            Syringe: (p) => <IconBase d={["m18 2 4 4", "m17 7 3-3", "M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5", "m9 11 4 4", "m5 19-3 3"]} {...p} />,
            ArrowLeft: (p) => <IconBase d="m12 19-7-7 7-7" {...p} />,
            Clock: (p) => <IconBase d={["M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z", "M12 6v6l4 2"]} {...p} />,
            CheckCircle2: (p) => <IconBase d={["M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z", "m9 12 2 2 4-4"]} {...p} />,
            Circle: (p) => <IconBase d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" {...p} />,
            AlertCircle: (p) => <IconBase d={["M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z", "M12 8v4", "M12 16h.01"]} {...p} />,
            File: (p) => <IconBase d={["M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z", "M14 2v6h6"]} {...p} />,
            Undo2: (p) => <IconBase d="M9 14 4 9l5-5" {...p} />,
            Trophy: (p) => <IconBase d={["M6 9H4.5a2.5 2.5 0 0 1 0-5H6", "M18 9h1.5a2.5 2.5 0 0 0 0-5H18", "M4 22h16", "M2 17h20", "M15.5 17a6 6 0 0 1-7 0V9h7z"]} {...p} />,
            Lock: (p) => <IconBase d={["M19 11H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2z", "M7 11V7a5 5 0 0 1 10 0v4"]} {...p} />,
            Share: (p) => <IconBase d={["M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8", "m16 6-4-4-4 4", "M12 2v13"]} {...p} />,
            PlusSquare: (p) => <IconBase d={["M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z", "M8 12h8", "M12 8v8"]} {...p} />,
            Plus: (p) => <IconBase d="M12 5v14M5 12h14" {...p} />,
            Sparkles: (p) => <IconBase d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" {...p} />,
            X: (p) => <IconBase d="M18 6 6 18M6 6l12 12" {...p} />,
            Trash2: (p) => <IconBase d={["M3 6h18", "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6", "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2", "M10 11v6", "M14 11v6"]} {...p} />,
            TrendingUp: (p) => <IconBase d={["M23 6l-9.5 9.5-5-5L1 18", "M17 6h6v6"]} {...p} />,
            TrendingDown: (p) => <IconBase d={["M23 18l-9.5-9.5-5 5L1 6", "M17 18h6v-6"]} {...p} />,
            Target: (p) => <IconBase d={["M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z", "M12 6a6 6 0 1 0 0 12 6 6 0 0 0 0-12z", "M12 10a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"]} {...p} />,
            Edit: (p) => <IconBase d={["M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7", "M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"]} {...p} />,
        };

        // --- UI Komponenten ---
        // Atomic UI components for consistent styling and behavior.

        /**
         * Generic Card component with default styling.
         */
        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-2xl shadow-sm border border-slate-100/60 p-5 ${className}`}>
                {children}
            </div>
        );

        /**
         * Status Badge component for visual categorization.
         */
        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-50 text-blue-700 ring-1 ring-blue-100",
                red: "bg-red-50 text-red-700 ring-1 ring-red-100",
                green: "bg-emerald-50 text-emerald-700 ring-1 ring-emerald-100",
                orange: "bg-orange-50 text-orange-700 ring-1 ring-orange-100"
            };
            return (
                <span className={`px-2.5 py-1 rounded-full text-[11px] font-semibold tracking-wide uppercase ${colors[color]}`}>
                    {children}
                </span>
            );
        };

        /**
         * Button component supporting different variants (primary, secondary, etc.) and icons.
         */
        const Button = ({ children, variant = 'primary', className = "", icon: Icon, onClick, disabled = false, type = "button", ...props }) => {
            const baseStyles = "w-full py-3.5 rounded-2xl text-sm font-semibold transition-all flex items-center justify-center gap-2.5 active:scale-[0.98] select-none touch-manipulation";
            const variants = {
                primary: "bg-slate-900 text-white shadow-lg shadow-slate-200 hover:bg-slate-800 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none",
                secondary: "bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-100/50 disabled:bg-slate-50 disabled:text-slate-400",
                outline: "border border-slate-200 text-slate-600 hover:border-indigo-300 hover:text-indigo-600 bg-white",
                ghost: "bg-transparent text-slate-500 hover:bg-slate-50"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyles} ${variants[variant]} ${className}`} {...props}>
                    {Icon && <Icon size={18} />}
                    {children}
                </button>
            );
        };

        /**
         * Global Toast notification component.
         * Auto-dismisses after 4 seconds. 
         * Supports "Undo" functionality.
         */
        const Toast = ({ message, onUndo, visible, onClose }) => {
            useEffect(() => {
                if (visible) {
                    const timer = setTimeout(onClose, 4000);
                    return () => clearTimeout(timer);
                }
            }, [visible, onClose]);

            if (!visible) return null;

            return (
                <div className="fixed bottom-6 left-4 right-4 z-[100] animate-slide-up pb-[env(safe-area-inset-bottom)]">
                    <div className="bg-slate-900/85 backdrop-blur-md border border-white/10 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between gap-3">
                        <div className="flex items-center gap-3">
                            <div className="bg-green-500/20 p-1 rounded-full">
                                <Icons.CheckCircle2 size={16} className="text-green-400" />
                            </div>
                            <span className="text-sm font-medium tracking-tight">{message}</span>
                        </div>
                        {onUndo && (
                            <button onClick={onUndo} className="text-indigo-200 hover:text-white text-xs font-bold uppercase tracking-wider flex items-center gap-1 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors">
                                <Icons.Undo2 size={14} /> Rückgängig
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- Modals ---

        /**
         * Modal for adding or editing a medication.
         * Handles parsing of existing dosage strings and strictly validated inputs.
         */
        const AddMedicationModal = ({ isOpen, onClose, onSave, initialData }) => {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState(''); // Separate Zustände für Menge und Einheit
            const [unit, setUnit] = useState('mg');
            const [instructions, setInstructions] = useState('');
            const [selectedTimes, setSelectedTimes] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    if (initialData) {
                        setName(initialData.name);
                        const match = (initialData.dosage || '').match(/^(\d+(?:\.\d+)?)\s*(mg|ml|g|Einheiten)$/i);
                        // Zerlegt den Dosierungs-String (z.B. "400 mg") in Wert und Einheit
                        if (match) {
                            setAmount(match[1]);
                            setUnit(match[2].toLowerCase() === 'einheiten' ? 'Einheiten' : match[2].toLowerCase());
                        } else {
                            setAmount(parseFloat(initialData.dosage) || '');
                            setUnit('mg');
                        }
                        setInstructions(initialData.instructions || '');
                        setSelectedTimes(initialData.times || []);
                    } else {
                        setName('');
                        setAmount('');
                        setUnit('mg');
                        setInstructions('');
                        setSelectedTimes([]);
                    }
                }
            }, [isOpen, initialData]);

            if (!isOpen) return null;

            const timeOptions = [
                { label: 'Morgens', time: '08:00' },
                { label: 'Mittags', time: '12:00' },
                { label: 'Abends', time: '18:00' },
                { label: 'Nachts', time: '22:00' }
            ];

            const toggleTime = (time) => {
                if (selectedTimes.includes(time)) {
                    setSelectedTimes(selectedTimes.filter(t => t !== time));
                } else {
                    setSelectedTimes([...selectedTimes, time].sort());
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || selectedTimes.length === 0) return;

                const medData = {
                    name,
                    // Setzt Menge und Einheit wieder zu einem String zusammen
                    dosage: amount ? `${amount} ${unit}` : 'Wie verordnet',
                    times: selectedTimes,
                    instructions: instructions || ''
                };

                if (initialData) {
                    onSave({ ...initialData, ...medData });
                } else {
                    onSave({
                        ...medData,
                        takenToday: [],
                        id: 'm' + Date.now()
                    });
                }
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-white rounded-t-3xl sm:rounded-3xl shadow-2xl overflow-hidden animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-900">{initialData ? 'Medikament bearbeiten' : 'Neues Medikament'}</h3>
                                <button onClick={onClose} className="p-2 bg-slate-50 rounded-full text-slate-500 hover:bg-slate-100"><Icons.X size={20} /></button>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-5">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Name</label>
                                    <input type="text" placeholder="z.B. Ibuprofen" className="input-neon" value={name} onChange={e => setName(e.target.value)} autoFocus />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Dosierung</label>
                                    {/* Eingabefelder für Dosierung: Zahl und Dropdown für Einheit */}
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="z.B. 400" className="input-neon flex-1" value={amount} onChange={e => setAmount(e.target.value)} />
                                        <div className="relative w-24">
                                            {/* Dropdown für Einheit */}
                                            <select className="input-neon input-neon-select w-full" value={unit} onChange={e => setUnit(e.target.value)}>
                                                <option value="mg">mg</option>
                                                <option value="g">g</option>
                                                <option value="ml">ml</option>
                                                <option value="Einheiten">Einheiten</option>
                                                <option value="Tropfen">Tropfen</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Zeiten</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {timeOptions.map((opt) => (
                                            <button type="button" key={opt.time} onClick={() => toggleTime(opt.time)} className={`p-3 rounded-xl border text-sm font-medium transition-all flex items-center justify-between ${selectedTimes.includes(opt.time) ? 'bg-indigo-50 border-indigo-200 text-indigo-700 shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                                <span>{opt.label}</span><span className="text-xs opacity-70">{opt.time}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Notizen</label>
                                    <textarea className="input-neon resize-none" placeholder="z.B. Vor dem Essen einnehmen" rows="2" value={instructions} onChange={e => setInstructions(e.target.value)}></textarea>
                                </div>
                                <div className="pt-2">
                                    <Button type="submit" disabled={!name || selectedTimes.length === 0} icon={Icons.CheckCircle2}>{initialData ? 'Speichern' : 'Erstellen'}</Button>
                                </div>
                            </form>
                        </div>
                    </div >
                </div >
            );
        };

        /**
         * Modal for creating new family members.
         */
        const AddProfileModal = ({ isOpen, onClose, onSave }) => {
            const [name, setName] = useState('');
            const [age, setAge] = useState('');
            const [relation, setRelation] = useState('child');

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name || !age) return;
                onSave({ name, age: parseInt(age), relation });
                setName(''); setAge(''); setRelation('child');
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-white rounded-t-3xl sm:rounded-3xl shadow-2xl overflow-hidden animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-900">Neues Profil</h3>
                                <button onClick={onClose} className="p-2 bg-slate-50 rounded-full text-slate-500 hover:bg-slate-100"><Icons.X size={20} /></button>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-5">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Name</label>
                                    <input type="text" placeholder="z.B. Max" className="input-neon" value={name} onChange={e => setName(e.target.value)} autoFocus />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Alter</label>
                                    <input type="number" placeholder="z.B. 12" className="input-neon" value={age} onChange={e => setAge(e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Rolle</label>
                                    <div className="relative">
                                        <select className="input-neon input-neon-select" value={relation} onChange={e => setRelation(e.target.value)}>
                                            <option value="child">Kind</option>
                                            <option value="partner">Partner</option>
                                            <option value="mother">Mutter</option>
                                            <option value="father">Vater</option>
                                            <option value="grandparent">Großelternteil</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="pt-2">
                                    <Button type="submit" disabled={!name || !age} icon={Icons.CheckCircle2}>Erstellen</Button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Mock iOS PWA Install Prompt.
         * Detects iOS environment checks if already standalone, and shows install instructions.
         */
        const IOSInstallPrompt = () => {
            const [show, setShow] = useState(false);
            useEffect(() => {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
                if (isIOS && !isStandalone) { setTimeout(() => setShow(true), 2000); }
            }, []);
            if (!show) return null;
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-slate-200/60 p-6 pb-8 z-50 animate-slide-up shadow-2xl rounded-t-3xl">
                    <div className="max-w-md mx-auto relative">
                        <button onClick={() => setShow(false)} className="absolute -top-2 right-0 text-slate-400 p-2"><Icons.Undo2 className="rotate-180" size={20} /></button>
                        <h3 className="font-bold text-slate-900 mb-2">Als App installieren</h3>
                        <div className="flex items-center gap-4 text-sm font-medium text-slate-700 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="flex items-center gap-2">1. <Icons.Share size={18} className="text-blue-500" /></div>
                            <div className="h-4 w-px bg-slate-300"></div>
                            <div className="flex items-center gap-2">2. "Zum Home-Bildschirm"</div>
                        </div>
                    </div>
                </div>
            );
        };
        // UserSettingsModal
        // Mock implementation of user settings/account view.
        const UserSettingsModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            const user = {
                name: "Julia Weber",
                email: "julia.weber@example.com",
                role: "Familien-Admin",
                plan: "Pro (Tier 2)",
                nextBill: "01.01.2026",
                version: "v1.2.4 (Beta)"
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative w-full max-w-md bg-white rounded-t-3xl sm:rounded-3xl shadow-2xl overflow-hidden animate-slide-up">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-900">Mein Account</h3>
                                <button onClick={onClose} className="p-2 bg-slate-50 rounded-full text-slate-500 hover:bg-slate-100"><Icons.X size={20} /></button>
                            </div>

                            <div className="flex flex-col items-center mb-8">
                                <div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center text-white text-2xl font-bold mb-3 shadow-lg">JW</div>
                                <h4 className="text-lg font-bold text-slate-900">{user.name}</h4>
                                <p className="text-slate-500 text-sm font-medium">{user.role}</p>
                            </div>

                            <div className="space-y-4">
                                <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Allgemein</p>
                                    <div className="space-y-3">
                                        <div className="flex justify-between text-sm"><span className="text-slate-500">Email</span><span className="font-semibold text-slate-800">{user.email}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-slate-500">Version</span><span className="font-semibold text-slate-800">{user.version}</span></div>
                                    </div>
                                </div>
                                <div className="p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100/50">
                                    <p className="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-3">Abo & Plan</p>
                                    <div className="space-y-3">
                                        <div className="flex justify-between text-sm"><span className="text-indigo-800/70">Plan</span><span className="font-bold text-indigo-900 flex items-center gap-1"><Icons.Sparkles size={12} /> {user.plan}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-indigo-800/70">Nächste Rechn.</span><span className="font-semibold text-indigo-900">{user.nextBill}</span></div>
                                    </div>
                                </div>
                            </div>

                            <div className="mt-8">
                                <Button variant="outline" className="text-red-500 border-red-100 bg-red-50 hover:bg-red-100 hover:border-red-200" onClick={onClose}>Abmelden</Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Modal to view details of a medical document (Lab Result or Prescription).
         * Dynamically renders content based on document type.
         */
        const DocumentViewerModal = ({ document, isOpen, onClose }) => {
            if (!isOpen || !document) return null;

            const isLab = document.type === 'lab-result';

            return (
                <div className="fixed inset-0 z-[70] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-fade-in" onClick={onClose}></div>
                    <div className="relative w-full max-w-lg bg-slate-50 rounded-t-3xl sm:rounded-3xl shadow-2xl overflow-hidden animate-slide-up max-h-[90vh] flex flex-col">
                        <div className="p-4 bg-white border-b border-slate-100 flex justify-between items-center z-10 sticky top-0">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-xl ${isLab ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'}`}>
                                    {isLab ? <Icons.Activity size={20} /> : <Icons.FileText size={20} />}
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-900 leading-tight">{document.title}</h3>
                                    <p className="text-xs font-medium text-slate-500">{new Date(document.date).toLocaleDateString('de-DE')} • {document.doctor}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-50 rounded-full text-slate-400 hover:bg-slate-100 transition-colors"><Icons.X size={20} /></button>
                        </div>

                        <div className="overflow-y-auto p-6 space-y-6">
                            {/* Summary Section */}
                            {document.content?.summary && (
                                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-sm text-slate-600 leading-relaxed">
                                    <span className="font-bold text-slate-900 block mb-1">Zusammenfassung</span>
                                    {document.content.summary}
                                </div>
                            )}

                            {/* Lab Values */}
                            {isLab && document.content?.values && (
                                <div>
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Messwerte</h4>
                                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                                        {document.content.values.map((val, i) => (
                                            <div key={i} className={`flex justify-between items-center p-4 ${i !== document.content.values.length - 1 ? 'border-b border-slate-50' : ''}`}>
                                                <div>
                                                    <span className="font-bold text-slate-800 text-sm block">{val.name}</span>
                                                    <span className="text-xs text-slate-400">{val.range ? `Ref: ${val.range}` : ''}</span>
                                                </div>
                                                <div className="text-right">
                                                    <div className={`font-bold ${val.status === 'critical' ? 'text-red-500' : (val.status === 'warning' ? 'text-orange-500' : 'text-slate-900')}`}>
                                                        {val.value} <span className="text-xs font-medium text-slate-400 ml-0.5">{val.unit}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Prescription content */}
                            {!isLab && document.content?.medications && (
                                <div>
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 px-1">Verordnungen</h4>
                                    <div className="space-y-2">
                                        {document.content.medications.map((med, i) => (
                                            <div key={i} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center">
                                                <span className="font-bold text-slate-800">{med.name}</span>
                                                <span className="px-2 py-1 bg-slate-50 text-slate-600 text-xs font-bold rounded-lg border border-slate-100">{med.amount}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-4 bg-slate-50 border-t border-slate-100 z-10 sticky bottom-0 flex gap-3">
                            <Button variant="outline" icon={Icons.Share}>Teilen</Button>
                            <Button icon={Icons.FileText}>Als PDF öffnen</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Screens ---

        /**
         * Simple Line-Chart Component using SVG.
         * Renders a smoothed Bezier curve or straight lines depending on implementation.
         */
        const SimpleChart = ({ data, color }) => {
            if (!data || data.length < 2) return null;
            const sorted = [...data].sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            const points = sorted.map(d => parseFloat(d.value.split('/')[0]));
            if (points.some(isNaN)) return null;

            const min = Math.min(...points);
            const max = Math.max(...points);
            const range = max - min || 1;
            // More padding for better visuals
            const paddedMin = min - range * 0.2;
            const paddedMax = max + range * 0.2;
            const paddedRange = paddedMax - paddedMin || 1;

            const width = 300; // Increased resolution
            const height = 80;

            const getX = (i) => (i / (points.length - 1)) * width;
            const getY = (v) => height - ((v - paddedMin) / paddedRange) * height;

            // Bezier curve for smoothness
            const controlPoint = (p1, p2, reverse) => {
                const smoothing = 0.2;
                const o = { x: p2[0] - p1[0], y: p2[1] - p1[1] };
                return [p1[0] + o.x * smoothing * (reverse ? -1 : 1), p1[1] + o.y * smoothing * (reverse ? -1 : 1)];
            };

            let pathData = `M 0,${getY(points[0])}`;
            for (let i = 0; i < points.length - 1; i++) {
                const x0 = getX(i);
                const y0 = getY(points[i]);
                const x1 = getX(i + 1);
                const y1 = getY(points[i + 1]);
                // Simple straight lines for now to ensure sharpness/accuracy
                pathData += ` L ${x1},${y1}`;
            }

            const areapath = `${pathData} L ${width},${height} L 0,${height} Z`;

            return (
                <div className="w-full h-32 mb-4 mt-2 px-2">
                    <svg viewBox={`0 (-5) ${width} ${height + 10}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id={"grad" + color.replace('#', '')} x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor={color} stopOpacity="0.15" />
                                <stop offset="100%" stopColor={color} stopOpacity="0" />
                            </linearGradient>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="2" stdDeviation="2" floodColor={color} floodOpacity="0.3" />
                            </filter>
                        </defs>
                        {/* Grid lines */}
                        <line x1="0" y1={height} x2={width} y2={height} stroke="#f1f5f9" strokeWidth="1" />
                        <line x1="0" y1={0} x2={width} y2={0} stroke="#f1f5f9" strokeWidth="1" />

                        <path d={areapath} fill={`url(#grad${color.replace('#', '')})`} stroke="none" />
                        <path d={pathData} fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ filter: 'url(#shadow)' }} />

                        {points.map((v, i) => (
                            <g key={i}>
                                <circle cx={getX(i)} cy={getY(v)} r="3.5" fill="white" stroke={color} strokeWidth="2" />
                            </g>
                        ))}
                    </svg>
                </div>
            )
        };

        /**
         * Weekly Report View.
         * Visualizes weekly progress with charts and summary statistics.
         * Currently uses hardcoded mock data for demonstration.
         */
        const WeeklyReportView = ({ onBack }) => {
            const stats = [
                { day: "Mo", val: 142, h: "60%" },
                { day: "Di", val: 128, h: "50%" },
                { day: "Mi", val: 135, h: "55%" },
                { day: "Do", val: 165, h: "75%" },
                { day: "Fr", val: 98, h: "30%" },
                { day: "Sa", val: 210, h: "90%" },
                { day: "So", val: 115, h: "40%" },
            ];

            return (
                <div className="flex flex-col h-full w-full bg-slate-50">
                    <div className="flex-none bg-slate-900 text-white pb-6 rounded-b-[2rem] pt-[env(safe-area-inset-top)] relative z-30 shadow-2xl">
                        <div className="px-4 pt-4 flex items-center mb-6">
                            <button onClick={onBack} className="p-2 bg-white/10 rounded-full hover:bg-white/20 backdrop-blur-md transition-colors"><Icons.ArrowLeft size={20} /></button>
                            <h2 className="flex-1 text-center font-bold text-lg mr-9">Wochenbericht</h2>
                        </div>
                        <div className="text-center px-6">
                            <p className="text-indigo-300 text-xs font-bold uppercase tracking-widest mb-1">Zusammenfassung</p>
                            <h1 className="text-3xl font-extrabold mb-1">KW 45</h1>
                            <p className="text-slate-400 text-sm font-medium">03. Nov - 09. Nov 2025</p>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar p-5 -mt-6 relative z-20 space-y-6">

                        {/* Hero Score Card */}
                        <div className="bg-white rounded-3xl p-6 shadow-xl shadow-slate-200/50 flex flex-col items-center animate-slide-up">
                            <div className="relative w-32 h-32 flex items-center justify-center mb-4">
                                <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                    <path className="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                    <path className="text-emerald-500 drop-shadow-lg" strokeDasharray="92, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" />
                                </svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                    <span className="text-3xl font-extrabold text-slate-800">92%</span>
                                    <span className="text-[10px] text-slate-400 font-bold uppercase">Med-Treue</span>
                                </div>
                            </div>
                            <div className="text-center">
                                <h3 className="font-bold text-slate-800">Ausgezeichnet!</h3>
                                <p className="text-sm text-slate-500 mt-1 max-w-[200px]">Du hast fast alle Medikamente pünktlich eingenommen. Weiter so!</p>
                            </div>
                        </div>

                        {/* Glucose Chart */}
                        <Card className="animate-slide-up" style={{ animationDelay: '0.1s' }}>
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Activity className="text-indigo-500" size={18} /> Blutzucker-Trend</h4>
                                <Badge color="blue">Ø 141 mg/dl</Badge>
                            </div>
                            <div className="h-40 flex items-end justify-between gap-2 px-1">
                                {stats.map((s, i) => (
                                    <div key={i} className="flex flex-col items-center gap-2 flex-1 group">
                                        <div className="w-full relative bg-slate-100 rounded-t-lg overflow-hidden h-32 flex items-end">
                                            <div
                                                className={`w-full rounded-t-lg transition-all duration-1000 animate-grow-bar ${s.val > 180 ? 'bg-red-400' : (s.val > 140 ? 'bg-orange-400' : 'bg-emerald-400')}`}
                                                style={{ '--h': s.h }}
                                            ></div>
                                        </div>
                                        <span className="text-[10px] font-bold text-slate-400">{s.day}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-4 flex gap-4 justify-center text-[10px] font-semibold text-slate-500">
                                <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-400"></div>Zielbereich</div>
                                <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-orange-400"></div>Erhöht</div>
                                <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-red-400"></div>Hoch</div>
                            </div>
                        </Card>

                        {/* Highlights Grid */}
                        <div className="grid grid-cols-2 gap-4 animate-slide-up" style={{ animationDelay: '0.2s' }}>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div className="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center mb-3"><Icons.Target size={20} /></div>
                                <p className="text-2xl font-bold text-slate-800">3x</p>
                                <p className="text-xs font-medium text-slate-500">Sportziel erreicht</p>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div className="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-3"><Icons.TrendingDown size={20} /></div>
                                <p className="text-2xl font-bold text-slate-800">-0.3<span className="text-sm text-slate-400 ml-1">kg</span></p>
                                <p className="text-xs font-medium text-slate-500">Gewichtstrend</p>
                            </div>
                        </div>

                        {/* Recommendations */}
                        <div className="bg-indigo-50/50 rounded-2xl p-5 border border-indigo-100/50 animate-slide-up" style={{ animationDelay: '0.3s' }}>
                            <h4 className="font-bold text-indigo-900 mb-3 flex items-center gap-2"><Icons.Sparkles size={16} /> Empfehlungen</h4>
                            <ul className="space-y-3">
                                <li className="flex gap-3 text-sm text-indigo-800/80">
                                    <div className="min-w-[4px] h-4 rounded-full bg-indigo-400 mt-1"></div>
                                    <p>Der Blutzucker war am Samstagabend erhöht. Achte bei Feiern auf versteckte Kohlenhydrate.</p>
                                </li>
                                <li className="flex gap-3 text-sm text-indigo-800/80">
                                    <div className="min-w-[4px] h-4 rounded-full bg-indigo-400 mt-1"></div>
                                    <p>Terminvereinbarung für Augenarzt steht noch aus.</p>
                                </li>
                            </ul>
                        </div>

                        <div className="h-6"></div>
                    </div>
                </div>
            );
        };

        /**
         * Family Home Screen / Dashboard.
         * Lists all available family profiles and provides access to global settings.
         */
        const FamilyHome = ({ profiles, onSelectProfile, onAddProfile, onOpenReport, onOpenSettings }) => (
            <div className="max-w-md mx-auto p-4 space-y-6 pb-32 pt-[env(safe-area-inset-top)] h-full overflow-y-auto no-scrollbar">
                <header className="flex justify-between items-end mb-8 pt-6 px-2">
                    <div><p className="text-slate-500 text-xs font-semibold uppercase tracking-wider mb-1">VitaHub</p><h1 className="text-3xl font-extrabold text-slate-900 tracking-tight">Meine Familie</h1></div>
                    <button onClick={onOpenSettings} className="h-11 w-11 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold shadow-md hover:bg-slate-800 transition-colors active:scale-95">JW</button>
                </header>
                <div className="grid gap-5">
                    {profiles.map((profile) => {
                        const total = profile.medications.length;
                        const taken = profile.medications.reduce((acc, med) => acc + (med.takenToday.length > 0 ? 1 : 0), 0);
                        const progress = total > 0 ? (taken / total) * 100 : 0;
                        return (
                            <div key={profile.id} onClick={() => onSelectProfile(profile)} className="group cursor-pointer transition-all active:scale-[0.98] touch-manipulation">
                                <Card className="flex items-center gap-5 border-l-0 hover:shadow-md transition-shadow relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-indigo-50 rounded-full blur-2xl opacity-50 group-hover:opacity-100 transition-opacity"></div>
                                    <div className="relative">
                                        <div className="h-14 w-14 rounded-full bg-slate-100 flex items-center justify-center text-2xl shadow-sm z-10 overflow-hidden">
                                            {profile.avatar ? <img src={profile.avatar} alt={profile.name} className="w-full h-full object-cover" /> : (profile.relation === 'self' ? '👩‍🦰' : '👵')}
                                        </div>
                                    </div>
                                    <div className="flex-1 z-10 min-w-0">
                                        <div className="flex justify-between items-center mb-1">
                                            <h3 className="font-bold text-slate-900 text-lg">{profile.name}</h3>
                                            {profile.streak > 0 && <span className="text-orange-600 text-[10px] font-bold flex items-center gap-1 bg-orange-50 px-2 py-1 rounded-full border border-orange-100"><Icons.Sparkles size={10} fill="currentColor" /> {profile.streak}</span>}
                                        </div>
                                        {total > 0 ? (
                                            <div className="mt-2.5">
                                                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-700 ease-out" style={{ width: `${progress}%` }} /></div>
                                                <div className="flex justify-between text-[10px] font-medium text-slate-400 mt-1.5"><span>Tagesfortschritt</span><span>{taken}/{total} erledigt</span></div>
                                            </div>
                                        ) : (
                                            <p className="text-sm text-slate-500 capitalize mt-1 flex items-center gap-1">{profile.relation === 'self' ? 'Ich' : 'Mutter'} <span className="w-1 h-1 rounded-full bg-slate-300"></span> {profile.age} Jahre</p>
                                        )}
                                    </div>
                                    <Icons.ChevronRight className="text-slate-300 group-hover:text-indigo-500 z-10 transition-colors" size={20} />
                                </Card>
                            </div>
                        );
                    })}
                    <Button variant="outline" className="border-dashed border-slate-300 text-slate-400 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50/50" icon={Icons.PlusSquare} onClick={onAddProfile}>Mitglied hinzufügen</Button>
                </div>

                {/* Wochenbericht Card */}
                <div onClick={onOpenReport} className="cursor-pointer active:scale-[0.98] transition-transform">
                    <Card className="bg-gradient-to-br from-indigo-600 to-violet-700 border-none text-white mt-8 shadow-xl shadow-indigo-200 relative overflow-hidden group">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 group-hover:bg-white/20 transition-colors"></div>
                        <div className="absolute bottom-0 left-0 w-24 h-24 bg-purple-500/30 rounded-full blur-xl -ml-5 -mb-5"></div>
                        <div className="flex items-center gap-4 relative z-10">
                            <div className="bg-white/20 p-3 rounded-xl backdrop-blur-sm border border-white/10"><Icons.Activity className="h-6 w-6 text-white" /></div>
                            <div className="flex-1"><h4 className="font-bold text-lg">Wochenbericht</h4><p className="text-indigo-100 text-sm opacity-90 font-medium">Dein Report für KW 45 ist da.</p></div>
                            <div className="bg-white/20 rounded-full p-1.5 backdrop-blur-sm group-hover:bg-white/30 transition-colors"><Icons.ChevronRight className="text-white" size={16} /></div>
                        </div>
                    </Card>
                </div>
            </div>
        );

        /**
         * Detailed Profile View.
         * Displays medications, vital values, and documents for a specific person.
         * Features a parallax header animation on scroll.
         */
        const ProfileView = ({ profile, onBack, showToast, onAddMedication, onDeleteMedication, onEditMedication }) => {
            const [activeTab, setActiveTab] = useState('protokoll');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [selectedDocument, setSelectedDocument] = useState(null);
            const [takenMeds, setTakenMeds] = useState({});
            const [showAllStats, setShowAllStats] = useState(false);
            const [expandedStats, setExpandedStats] = useState({});

            const toggleStatExpand = (type) => {
                setExpandedStats(prev => ({ ...prev, [type]: !prev[type] }));
            };

            const headerRef = useRef(null);
            const avatarRef = useRef(null);
            const nameRef = useRef(null);
            const patientLabelRef = useRef(null);
            const conditionsRef = useRef(null);

            const handleScroll = (e) => {
                const scrolled = e.currentTarget.scrollTop;
                const maxScroll = 150;
                const p = Math.min(scrolled / maxScroll, 1);

                requestAnimationFrame(() => {
                    if (headerRef.current) {
                        headerRef.current.style.height = `${280 - (160 * p)}px`;
                        headerRef.current.style.boxShadow = p > 0.8 ? '0 4px 20px -5px rgba(0,0,0,0.1)' : 'none';
                        headerRef.current.style.borderColor = p > 0.9 ? '#f1f5f9' : 'transparent';
                    }
                    if (avatarRef.current) {
                        const size = 96 - (56 * p);
                        avatarRef.current.style.width = `${size}px`;
                        avatarRef.current.style.height = `${size}px`;
                        avatarRef.current.style.top = `${60 - (50 * p)}px`;
                    }
                    if (nameRef.current) {
                        nameRef.current.style.top = `${165 - (115 * p)}px`;
                        nameRef.current.style.fontSize = `${1.5 - (0.3 * p)}rem`;
                    }
                    if (patientLabelRef.current) {
                        patientLabelRef.current.style.opacity = Math.max(0, 1 - p);
                    }
                    if (conditionsRef.current) {
                        conditionsRef.current.style.opacity = Math.max(0, 1 - (p * 3));
                        conditionsRef.current.style.pointerEvents = p > 0.2 ? 'none' : 'auto';
                    }
                });
            };

            const toggleMed = (med, time) => {
                const dateKey = selectedDate.toISOString().split('T')[0];
                const key = `${dateKey}_${med.id}_${time}`;
                // Check if it's explicitly set in state, otherwise default to true if it's a past date
                const isPastDate = new Date(dateKey) < new Date(new Date().toISOString().split('T')[0]);
                const currentState = takenMeds.hasOwnProperty(key) ? takenMeds[key] : isPastDate;

                const isNowTaken = !currentState;
                setTakenMeds(prev => ({ ...prev, [key]: isNowTaken }));
                if (navigator.vibrate) navigator.vibrate(50);
                showToast(isNowTaken ? `${med.name} eingenommen` : `Einnahme zurückgesetzt`,
                    () => setTakenMeds(prev => ({ ...prev, [key]: !isNowTaken })));
            };

            const allTasks = profile.medications.flatMap(m => m.times.map(t => ({ id: m.id, time: t })));
            const allTaken = allTasks.length > 0 && allTasks.every(task => {
                const dateKey = selectedDate.toISOString().split('T')[0];
                const key = `${dateKey}_${task.id}_${task.time}`;
                const isPastDate = new Date(dateKey) < new Date(new Date().toISOString().split('T')[0]);
                // Return state value if present, otherwise true for past dates, false for today/future
                return takenMeds.hasOwnProperty(key) ? takenMeds[key] : isPastDate;
            });

            const medsByTime = {};
            profile.medications.forEach(med => {
                med.times.forEach(t => {
                    if (!medsByTime[t]) medsByTime[t] = [];
                    medsByTime[t].push(med);
                });
            });
            const sortedTimes = Object.keys(medsByTime).sort();

            const getTimeLabel = (t) => {
                const hour = parseInt(t.split(':')[0]);
                if (hour < 10) return 'Morgens';
                if (hour < 14) return 'Mittags';
                if (hour < 17) return 'Nachmittags';
                if (hour < 22) return 'Abends';
                return 'Nachts';
            };

            const measurementLabels = { "blood-sugar": "Blutzucker", "blood-pressure": "Blutdruck", "weight": "Gewicht", "temperature": "Temperatur" };
            const getUnit = (type) => ({ "blood-sugar": "mg/dl", "weight": "kg", "temperature": "°C", "blood-pressure": "mmHg" }[type] || "mg/dl");
            const getBloodSugarColor = (v, type) => {
                if (type !== "blood-sugar") return "text-slate-800";
                const n = parseInt(v); if (isNaN(n)) return ""; if (n < 70 || n > 140) return "text-red-600"; if (n > 120) return "text-orange-500"; return "text-emerald-600";
            };

            return (
                <div className="flex flex-col h-full bg-slate-50/50 w-full relative">
                    <div ref={headerRef} className="fixed top-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md z-40 transition-shadow duration-100 overflow-hidden border-b border-transparent" style={{ height: '280px' }}>
                        <div className="absolute top-0 left-0 right-0 h-16 flex items-center px-4 z-50 pt-[env(safe-area-inset-top)]">
                            <button onClick={onBack} className="p-2.5 hover:bg-slate-100 rounded-full text-slate-600 transition-colors touch-manipulation">
                                <Icons.ArrowLeft className="h-6 w-6" />
                            </button>
                            <span ref={patientLabelRef} className="absolute right-6 font-bold text-slate-400 text-[10px] tracking-widest uppercase transition-opacity duration-300">Patientenprofil</span>
                        </div>
                        <div ref={avatarRef} className="absolute bg-slate-100 text-slate-400 rounded-full flex items-center justify-center shadow-inner overflow-hidden z-20 origin-center" style={{ width: '96px', height: '96px', top: '60px', left: '50%', transform: 'translateX(-50%)' }}>
                            {profile.avatar ? <img src={profile.avatar} alt={profile.name} className="w-full h-full object-cover" /> : (profile.relation === 'self' ? '👩‍🦰' : '👵')}
                        </div>
                        <h2 ref={nameRef} className="absolute text-slate-900 tracking-tight z-20 whitespace-nowrap origin-center" style={{ top: '165px', left: '50%', transform: 'translateX(-50%)', fontSize: '1.5rem' }}>{profile.name}</h2>
                        {profile.conditions.length > 0 && (
                            <div ref={conditionsRef} className="absolute w-full flex justify-center gap-2 top-[205px] z-10 transition-opacity">
                                {profile.conditions.map(c => <span key={c} className="px-3 py-1 bg-white border border-indigo-100 text-indigo-600 rounded-full text-xs font-semibold shadow-sm">{c}</span>)}
                            </div>
                        )}
                        <div className="absolute bottom-0 left-0 right-0 flex justify-around px-2 pb-0 bg-white/50 backdrop-blur-sm z-30">
                            {[
                                { id: 'protokoll', label: 'Protokoll' },
                                { id: 'plan', label: 'Medikamente' },
                                { id: 'stats', label: 'Werte' },
                                { id: 'docs', label: 'Dokumente' }
                            ].map((tab) => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 pb-4 text-xs sm:text-sm font-semibold transition-all relative touch-manipulation pt-2 ${activeTab === tab.id ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-500'}`}>
                                    {tab.label}
                                    {activeTab === tab.id && <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-8 h-1 bg-indigo-600 rounded-full shadow-lg shadow-indigo-200" />}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar p-5 space-y-6 pt-[290px] w-full" onScroll={handleScroll}>
                        {activeTab === 'protokoll' && (
                            <div className="space-y-6 animate-slide-up">
                                {/* Week Calendar Strip */}
                                <div className="flex justify-between items-center overflow-x-auto pb-2 gap-2 no-scrollbar px-1 -mx-2 sm:mx-0">
                                    {(() => {
                                        const week = [];
                                        const curr = new Date();
                                        const day = curr.getDay();
                                        const diff = curr.getDate() - day + (day === 0 ? -6 : 1);
                                        const monday = new Date(curr.setDate(diff));

                                        for (let i = 0; i < 7; i++) {
                                            const d = new Date(monday);
                                            d.setDate(monday.getDate() + i);
                                            week.push(d);
                                        }

                                        return week.map(date => {
                                            const dKey = date.toISOString().split('T')[0];
                                            const sKey = selectedDate.toISOString().split('T')[0];
                                            const isSelected = dKey === sKey;
                                            const isToday = dKey === new Date().toISOString().split('T')[0];

                                            return (
                                                <button
                                                    key={dKey}
                                                    onClick={() => setSelectedDate(date)}
                                                    className={`relative flex flex-col items-center flex-1 min-w-[40px] p-2.5 rounded-2xl transition-all duration-300 touch-manipulation ${isSelected ? 'bg-indigo-600 text-white shadow-xl shadow-indigo-200 scale-105 z-10' : 'bg-white text-slate-400 hover:bg-slate-50 border border-slate-100'}`}
                                                >
                                                    <span className={`text-[10px] uppercase font-bold tracking-wider mb-1 ${isSelected ? 'opacity-80' : 'opacity-60'}`}>{date.toLocaleDateString('de-DE', { weekday: 'short' }).slice(0, 2)}</span>
                                                    <span className={`text-base font-bold ${isToday && !isSelected ? 'text-indigo-600' : ''}`}>{date.getDate()}</span>
                                                    {isToday && <div className={`absolute -bottom-1 w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-indigo-600'}`}></div>}
                                                </button>
                                            );
                                        });
                                    })()}
                                </div>

                                {allTaken && (
                                    <div className="bg-emerald-50/80 border border-emerald-100/50 backdrop-blur-sm rounded-2xl p-5 flex items-center gap-4 animate-zoom-in shadow-sm shadow-emerald-100">
                                        <div className="bg-emerald-100 p-2.5 rounded-full text-emerald-600"><Icons.Trophy size={24} className="relative z-10" /></div>
                                        <div><h4 className="font-bold text-emerald-900">Tagesziel erreicht!</h4><p className="text-xs font-medium text-emerald-700/80 mt-0.5">Alle Medikamente für {selectedDate.getDate() === new Date().getDate() ? 'heute' : 'diesen Tag'} eingenommen.</p></div>
                                    </div>
                                )}

                                <div className="flex items-center justify-between px-1">
                                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                        <Icons.Clock className="text-indigo-500" size={20} />
                                        {selectedDate.toDateString() === new Date().toDateString() ? 'Einnahme heute' : `Einnahme am ${selectedDate.toLocaleDateString('de-DE', { weekday: 'long' })}`}
                                    </h3>
                                    <span className="text-xs font-semibold text-slate-500 bg-white px-3 py-1.5 rounded-lg border border-slate-100 shadow-sm">{selectedDate.toLocaleDateString('de-DE', { day: 'numeric', month: 'short' })}</span>
                                </div>

                                {profile.medications.length === 0 ? (
                                    <div className="text-center py-16 bg-white rounded-3xl border-2 border-dashed border-slate-100"><div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300"><Icons.Pill size={32} /></div><p className="text-slate-500 font-medium">Keine Medikamente</p></div>
                                ) : (
                                    <div className="space-y-6">
                                        {sortedTimes.map(time => (
                                            <div key={time} className="animate-fade-in">
                                                <div className="flex items-center gap-3 mb-3 px-1">
                                                    <span className="text-sm font-bold text-slate-900 bg-slate-100 px-2.5 py-1 rounded-lg">{time}</span>
                                                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{getTimeLabel(time)}</span>
                                                    <div className="h-px bg-slate-100 flex-1"></div>
                                                </div>
                                                <div className="space-y-3">
                                                    {medsByTime[time].map(med => {
                                                        const dateKey = selectedDate.toISOString().split('T')[0];
                                                        const key = `${dateKey}_${med.id}_${time}`;
                                                        const isPastDate = new Date(dateKey) < new Date(new Date().toISOString().split('T')[0]);
                                                        const isTaken = takenMeds.hasOwnProperty(key) ? takenMeds[key] : isPastDate;

                                                        return (
                                                            <div key={key} onClick={() => toggleMed(med, time)} className={`bg-white rounded-2xl p-4 border transition-all cursor-pointer relative overflow-hidden group active:scale-[0.99] touch-manipulation ${isTaken ? 'border-transparent bg-slate-50/50' : 'border-slate-100 shadow-sm hover:border-indigo-200'}`}>
                                                                <div className="flex justify-between items-center relative z-10">
                                                                    <div className={isTaken ? 'opacity-50 grayscale transition-all' : 'transition-all'}>
                                                                        <h4 className={`font-bold text-base ${isTaken ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{med.name}</h4>
                                                                        <div className="flex items-center gap-2 mt-1">
                                                                            <span className="text-xs font-semibold text-slate-500 bg-slate-100/80 px-2 py-0.5 rounded-md">{med.dosage}</span>
                                                                            {med.instructions && <span className="text-[10px] text-slate-400 italic max-w-[150px] truncate">{med.instructions}</span>}
                                                                        </div>
                                                                    </div>
                                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${isTaken ? 'bg-emerald-500 text-white shadow-md shadow-emerald-200 scale-110' : 'bg-slate-100 text-slate-300 group-hover:bg-indigo-50 group-hover:text-indigo-400'}`}>
                                                                        {isTaken ? <Icons.CheckCircle2 size={18} /> : <Icons.Circle size={18} />}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'plan' && (
                            <div className="space-y-4 animate-slide-up">
                                <div className="flex items-center justify-between px-1 mb-2">
                                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icons.Pill className="text-indigo-500" size={20} /> Alle Medikamente</h3>
                                </div>
                                {profile.medications.length === 0 ? (
                                    <div className="text-center py-10"><p className="text-slate-400 text-sm">Liste ist leer.</p></div>
                                ) : (
                                    <div className="space-y-3">
                                        {profile.medications.map(med => (
                                            <Card key={med.id} className="group relative pr-12">
                                                <div>
                                                    <h4 className="font-bold text-slate-800">{med.name}</h4>
                                                    <p className="text-sm font-medium text-slate-500 mt-1">{med.dosage}</p>
                                                    <div className="flex gap-2 mt-3 flex-wrap">{med.times.map(t => <span key={t} className="text-[10px] px-2 py-1 rounded-md font-bold tracking-wide bg-indigo-50 text-indigo-600 border border-indigo-100">{t}</span>)}</div>
                                                    {med.refillDate && <div className="mt-3 flex items-center gap-2 text-xs font-semibold text-orange-600 bg-orange-50 px-2 py-1 rounded-lg w-fit"><Icons.AlertCircle size={12} /> Nachschub: {new Date(med.refillDate).toLocaleDateString()}</div>}
                                                </div>
                                                <div className="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col gap-2">
                                                    <button onClick={() => onEditMedication(med)} className="p-2 text-slate-300 hover:text-indigo-500 hover:bg-indigo-50 rounded-full transition-colors"><Icons.Edit size={18} /></button>
                                                    <button onClick={() => onDeleteMedication(med.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"><Icons.Trash2 size={18} /></button>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                )}
                                <div className="pt-4">
                                    <Button variant="outline" className="border-dashed border-slate-300 text-slate-400 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50/50" icon={Icons.Plus} onClick={() => onAddMedication(true)}>Medikament hinzufügen</Button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6 animate-slide-up">
                                <div><h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2 px-1"><Icons.Calendar className="text-indigo-500" size={20} /> Termine</h3>
                                    {profile.appointments.length === 0 ? <p className="text-slate-400 italic text-sm text-center py-4">Keine Termine.</p> :
                                        <div className="space-y-4">{profile.appointments.map(app => (
                                            <Card key={app.id} className="relative overflow-hidden border-l-[6px] border-l-indigo-500 pl-6"><div className="flex justify-between items-start z-10 relative"><div><p className="text-[10px] font-bold uppercase tracking-wider text-indigo-600 mb-1">{app.specialty}</p><h4 className="font-bold text-slate-900 text-lg leading-tight">{app.title}</h4><p className="text-sm text-slate-500 font-medium mt-1">Dr. {app.doctor.replace('Dr. ', '')}</p></div><div className="text-center bg-slate-50 p-2.5 rounded-xl border border-slate-100 min-w-[3.5rem]"><p className="font-bold text-slate-900 text-sm">{app.date.slice(8)}.{app.date.slice(5, 7)}.</p><p className="text-xs font-semibold text-slate-400 mt-0.5">{app.time}</p></div></div><div className="mt-4 flex items-center gap-2 text-xs font-medium text-slate-500 bg-slate-50/50 -mx-5 -mb-5 p-3 px-5 border-t border-slate-100"><div className="w-2 h-2 rounded-full bg-slate-300"></div> {app.location}, {app.address}</div></Card>
                                        ))}</div>}
                                </div>
                                <div><h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2 px-1"><Icons.Activity className="text-indigo-500" size={20} /> Vitalwerte</h3>
                                    {profile.measurements.length === 0 ? <p className="text-slate-400 italic text-sm text-center">Keine Daten.</p> : (
                                        <div className="space-y-6">
                                            {Array.from(new Set(profile.measurements.map(m => m.type))).map(type => {
                                                const typeMeds = profile.measurements.filter(m => m.type === type).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
                                                const typeColor = { "blood-sugar": "#10b981", "blood-pressure": "#ef4444", "weight": "#3b82f6", "temperature": "#f97316" }[type] || "#6366f1";
                                                const isExpanded = expandedStats[type];
                                                const visibleMeds = isExpanded ? typeMeds : typeMeds.slice(0, 3);
                                                return (
                                                    <div key={type} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                                        <div className="p-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                                                            <h4 className="font-bold text-slate-700 capitalize flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{ background: typeColor }}></div>{measurementLabels[type] || type}</h4>
                                                            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{getUnit(type)}</span>
                                                        </div>
                                                        <div className="p-4 pb-0 bg-gradient-to-b from-white to-slate-50/30"><SimpleChart data={typeMeds} color={typeColor} /></div>
                                                        {visibleMeds.map((m, i) => (
                                                            <div key={m.id} className={`flex justify-between items-center p-4 hover:bg-slate-50 transition-colors ${i !== visibleMeds.length - 1 ? 'border-b border-slate-50' : ''}`}>
                                                                <div className="flex-1"><span className={`font-bold text-base ${getBloodSugarColor(m.value, m.type)}`}>{m.value}</span>{m.notes && <p className="text-[10px] font-medium text-slate-400 mt-0.5">{m.notes}</p>}</div>
                                                                <div className="text-right"><div className="text-xs font-medium text-slate-600">{new Date(m.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}</div><div className="text-[10px] text-slate-400">{m.time}</div></div>
                                                            </div>
                                                        ))}
                                                        {typeMeds.length > 3 && (<div onClick={() => toggleStatExpand(type)} className="p-3 text-center text-xs font-bold text-indigo-500 uppercase tracking-widest border-t border-slate-50 cursor-pointer hover:bg-indigo-50 transition-colors">{isExpanded ? "Weniger anzeigen" : `Alle ${typeMeds.length} Werte anzeigen`}</div>)}
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {activeTab === 'docs' && (
                            <div className="space-y-6 animate-slide-up">
                                <div><h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2 px-1"><Icons.Syringe className="text-indigo-500" size={20} /> Impfpass</h3><div className="grid gap-3">{profile.vaccinations.map(vac => (<div key={vac.id} className="flex justify-between items-center p-4 bg-white border border-slate-100 rounded-2xl shadow-sm"><div><span className="font-bold text-slate-800 text-sm block">{vac.name}</span>{vac.nextDue && <span className="text-xs font-medium text-slate-400 mt-1 block">Nächste: {vac.nextDue.slice(0, 4)}</span>}</div><Badge color={vac.status === 'completed' ? 'green' : (vac.status === 'overdue' ? 'red' : 'orange')}>{vac.status === 'upcoming' ? 'Fällig' : 'Geschützt'}</Badge></div>))}</div></div>
                                <div><h3 className="font-bold text-lg text-slate-800 mb-4 px-1">Dokumente</h3>{profile.documents.length === 0 ? <div className="text-center p-10 bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-200/60"><Icons.FileText size={24} className="text-slate-300 mx-auto mb-2" /><p className="text-xs font-medium text-slate-400">Keine Dokumente abgelegt</p></div> : profile.documents.map(doc => (<Card key={doc.id} onClick={() => setSelectedDocument(doc)} className="flex items-center gap-4 mb-3 hover:bg-slate-50 transition-colors cursor-pointer group p-4"><div className="bg-blue-50 p-3 rounded-xl text-blue-600 group-hover:bg-blue-100 group-hover:text-blue-700 transition-colors"><Icons.FileText size={20} /></div><div className="flex-1 min-w-0"><h4 className="font-bold text-slate-800 text-sm truncate">{doc.title}</h4><p className="text-xs font-medium text-slate-500 mt-1">{new Date(doc.date).toLocaleDateString('de-DE')} • {doc.doctor}</p></div><Icons.ChevronRight size={18} className="text-slate-300 group-hover:text-slate-500" /></Card>))}</div>
                                <Button variant="outline" icon={Icons.File}>Dokument scannen</Button>
                            </div>
                        )}
                        {/* Extra Space am Ende für gutes Scrollen */}
                        <div className="h-20"></div>
                        <DocumentViewerModal document={selectedDocument} isOpen={!!selectedDocument} onClose={() => setSelectedDocument(null)} />
                    </div>
                </div>
            );
        };

        // --- App Component ---

        /**
         * Root Layout Component.
         * Manages global state (profiles, selected view, active modals).
         */
        function App() {
            // Initial Mock Data: Defines the default state of the application.
            const [profiles, setProfiles] = useState([
                {
                    id: "petra", name: "Petra Weber", relation: "mother", age: 58, conditions: ["Typ 1 Diabetes"], streak: 0, achievements: [], sharedWith: [],
                    medications: [
                        { id: "m1", name: "Insulin Glargin", dosage: "20 Einheiten", times: ["08:00", "20:00"], takenToday: [], instructions: "Vor dem Essen spritzen" },
                        { id: "m2", name: "Metformin", dosage: "500mg", times: ["08:00", "20:00"], takenToday: [], refillDate: "2025-11-20" }
                    ],
                    measurements: [
                        { id: "me1", type: "blood-sugar", value: "142", date: "2025-11-13", time: "08:45", notes: "Nach Frühstück" },
                        { id: "me2", type: "blood-sugar", value: "128", date: "2025-11-12", time: "08:30", notes: "Nüchtern" },
                        { id: "me3", type: "blood-pressure", value: "135/85", date: "2025-11-11", time: "18:00" },
                        { id: "me4", type: "blood-sugar", value: "165", date: "2025-11-11", time: "14:20", notes: "Nach Mittagessen" },
                        { id: "me5", type: "weight", value: "72.5", date: "2025-11-10", time: "09:00" },
                        { id: "me6", type: "blood-sugar", value: "98", date: "2025-11-10", time: "08:15", notes: "Nüchtern" },
                        { id: "me7", type: "temperature", value: "37.1", date: "2025-11-09", time: "19:30", notes: "Leichtes Frösteln" },
                        { id: "me8", type: "blood-sugar", value: "210", date: "2025-11-09", time: "20:00", notes: "Nach Geburtstagsfeier" },
                        { id: "me9", type: "blood-pressure", value: "130/82", date: "2025-11-08", time: "10:00" },
                        { id: "me10", type: "blood-sugar", value: "115", date: "2025-11-08", time: "08:30", notes: "Nüchtern" },
                        { id: "me11", type: "blood-sugar", value: "155", date: "2025-11-07", time: "20:15", notes: "Abendessen" },
                        { id: "me12", type: "weight", value: "72.8", date: "2025-11-03", time: "09:00" },
                        { id: "me13", type: "blood-sugar", value: "85", date: "2025-11-03", time: "16:00", notes: "Nach Spaziergang" }
                    ],
                    appointments: [
                        { id: "a1", title: "Diabetologe Kontrolle", doctor: "Dr. Weber", specialty: "Diabetologie", date: "2025-11-18", time: "10:30", location: "Diabetes Zentrum", address: "Hauptstr. 45" }
                    ],
                    documents: [
                        {
                            id: "d1",
                            title: "Laborergebnis HbA1c",
                            type: "lab-result",
                            date: "2025-11-01",
                            doctor: "Dr. Weber",
                            content: {
                                summary: "Die Blutzuckerwerte zeigen eine stabile Tendenz. Der HbA1c-Wert hat sich im Vergleich zum Vorquartal (7.1%) leicht verbessert. Nierenparameter sind unauffällig.",
                                values: [
                                    { name: "HbA1c", value: "6.8", unit: "%", range: "< 7.0", status: "ok" },
                                    { name: "Glukose (nüchtern)", value: "115", unit: "mg/dl", range: "70-100", status: "warning" },
                                    { name: "Cholesterin gesamt", value: "195", unit: "mg/dl", range: "< 200", status: "ok" },
                                    { name: "HDL", value: "55", unit: "mg/dl", range: "> 45", status: "ok" },
                                    { name: "LDL", value: "118", unit: "mg/dl", range: "< 115", status: "warning" },
                                    { name: "Triglyceride", value: "145", unit: "mg/dl", range: "< 150", status: "ok" },
                                    { name: "Kreatinin", value: "0.85", unit: "mg/dl", range: "0.5-0.9", status: "ok" },
                                    { name: "GFR", value: "88", unit: "ml/min", range: "> 90", status: "warning" }
                                ]
                            }
                        },
                        {
                            id: "d2",
                            title: "Insulin Rezept",
                            type: "prescription",
                            date: "2025-10-15",
                            doctor: "Dr. Weber",
                            content: {
                                summary: "Folgerezept für das Quartal 4/2025.",
                                medications: [
                                    { name: "Insulin Glargin 100 E/ml", amount: "10x 3ml (N3)" },
                                    { name: "Metformin 500mg", amount: "180 Stk. (N3)" },
                                    { name: "Teststreifen Accu-Chek", amount: "50 Stk." }
                                ]
                            }
                        }
                    ],
                    vaccinations: [
                        { id: "v1", name: "Grippe", date: "2024-10-15", nextDue: "2025-10-15", status: "upcoming" }
                    ]
                },
                {
                    id: "julia", name: "Julia Weber", relation: "self", age: 22, conditions: [], streak: 0, achievements: [], sharedWith: [],
                    medications: [], measurements: [], appointments: [], documents: [], vaccinations: []
                }
            ]);

            const [currentView, setCurrentView] = useState('home'); // 'home', 'profile', 'report'
            const [selectedProfileId, setSelectedProfileId] = useState(null);
            const [currentUser] = useState("julia");
            const [toast, setToast] = useState(null);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [editingMedication, setEditingMedication] = useState(null);

            // --- Handlers ---

            const triggerToast = (msg, undo) => { setToast({ msg, undo }); };

            // Logic to add or update a medication in the selected profile's list.
            const handleSaveMedication = (medData) => {
                setProfiles(prev => prev.map(p => {
                    if (p.id !== selectedProfileId) return p;
                    const existingIndex = p.medications.findIndex(m => m.id === medData.id);
                    if (existingIndex >= 0) {
                        const updatedMeds = [...p.medications];
                        updatedMeds[existingIndex] = { ...updatedMeds[existingIndex], ...medData };
                        return { ...p, medications: updatedMeds };
                    } else {
                        return { ...p, medications: [...p.medications, medData] };
                    }
                }));
                triggerToast(`${medData.name} ${editingMedication ? 'aktualisiert' : 'hinzugefügt'}`, null);
                setEditingMedication(null);
            };

            const handleDeleteMedication = (medId) => {
                setProfiles(prev => prev.map(p => p.id === selectedProfileId ? { ...p, medications: p.medications.filter(m => m.id !== medId) } : p));
                triggerToast(`Medikament gelöscht`, null);
            };

            const handleAddProfile = (data) => {
                const newProfile = {
                    id: "p" + Date.now(),
                    name: data.name,
                    relation: data.relation,
                    age: data.age,
                    avatar: null,
                    conditions: [],
                    streak: 0,
                    medications: [],
                    measurements: [],
                    appointments: [],
                    documents: [],
                    vaccinations: [],
                    achievements: [],
                    sharedWith: []
                };
                setProfiles([...profiles, newProfile]);
                triggerToast(`${data.name} wurde hinzugefügt`, null);
            };

            const selectedProfile = profiles.find(p => p.id === selectedProfileId);

            const openAddMedication = () => {
                setEditingMedication(null);
                setIsAddModalOpen(true);
            };

            const openEditMedication = (med) => {
                setEditingMedication(med);
                setIsAddModalOpen(true);
            };

            const closeMedicationModal = () => {
                setIsAddModalOpen(false);
                setTimeout(() => setEditingMedication(null), 300);
            };

            return (
                <div className="flex justify-center bg-slate-100 min-h-screen">
                    <div className="w-full max-w-md bg-slate-50/30 shadow-2xl overflow-hidden relative h-[100dvh] flex-col">

                        {/* View Router */}
                        {currentView === 'report' ? (
                            <WeeklyReportView onBack={() => setCurrentView('home')} />
                        ) : currentView === 'profile' && selectedProfile ? (
                            <ProfileView
                                profile={selectedProfile}
                                currentUser={currentUser}
                                onBack={() => { setCurrentView('home'); setSelectedProfileId(null); }}
                                showToast={triggerToast}
                                onAddMedication={openAddMedication}
                                onDeleteMedication={handleDeleteMedication}
                                onEditMedication={openEditMedication}
                            />
                        ) : (
                            <FamilyHome
                                profiles={profiles}
                                currentUser={currentUser}
                                onSelectProfile={(p) => { setSelectedProfileId(p.id); setCurrentView('profile'); }}
                                onAddProfile={() => setIsProfileModalOpen(true)}
                                onOpenReport={() => setCurrentView('report')}
                                onOpenSettings={() => setIsSettingsModalOpen(true)}
                            />
                        )}

                        <Toast message={toast?.msg} onUndo={toast?.undo} visible={!!toast} onClose={() => setToast(null)} />
                        <IOSInstallPrompt />
                        <AddMedicationModal
                            isOpen={isAddModalOpen}
                            onClose={closeMedicationModal}
                            onSave={handleSaveMedication}
                            initialData={editingMedication}
                        />
                        <AddProfileModal isOpen={isProfileModalOpen} onClose={() => setIsProfileModalOpen(false)} onSave={handleAddProfile} />
                        <UserSettingsModal isOpen={isSettingsModalOpen} onClose={() => setIsSettingsModalOpen(false)} />
                    </div>
                </div>
            );
        }

        // Mount the React Application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
